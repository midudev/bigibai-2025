---
import Avatar from '@/components/Avatar.astro'
import Button from '@/components/Button.astro'
import { supabaseAdmin } from '@/supabase-admin'
import TicketIcon from '@/icons/ticket.svg'

interface Props {
  participationCount: number
}

let { participationCount } = Astro.props

const user = Astro.locals.user

const rawDisplayName =
  user?.user_metadata?.full_name ?? user?.user_metadata?.name ?? user?.email ?? 'Usuario'

const displayName =
  typeof rawDisplayName === 'string' && rawDisplayName.trim().length > 0
    ? rawDisplayName
    : 'Usuario'

const fallbackInitial = displayName.trim().charAt(0).toUpperCase()

const avatarUrl =
  user?.user_metadata?.avatar_url ??
  user?.user_metadata?.picture ??
  user?.user_metadata?.avatar ??
  null

// Obtener el número de participaciones del usuario
if (typeof participationCount === 'undefined' && user) {
  const { data: coupons } = await supabaseAdmin
    .from('coupons')
    .select('id')
    .eq('used_by', user.id)
    .eq('is_used', true)

  participationCount = coupons?.length || 0
}

// Verificar la página actual
const currentPath = Astro.url.pathname
const isRegistroPage = currentPath === '/registro'
---

<header class="overflow-x-clip pt-24 pb-5" aria-label="Big Ibai">
  <div class="absolute top-4 right-4 z-20">
    <div id="header-auth-section" class="flex items-center gap-3">
      {
        /*
        !user && !isRegistroPage && (
          <a href="/registro">
            <Button id="header-login-btn" variant="brand" size="sm">
              Iniciar sesión
            </Button>
          </a>
        )
      */
      }

      {
        user && (
          <div class="flex items-center gap-3">
            <a
              id="participation-badge"
              href="/dashboard"
              aria-describedby="participation-tooltip"
              class="group flex items-center gap-3 rounded-full bg-black/50 px-2 py-1 backdrop-blur-lg transition-all duration-300 hover:bg-black/70 active:scale-90"
            >
              <Avatar
                src={avatarUrl ?? undefined}
                alt={displayName}
                size="sm"
                fallback={fallbackInitial}
                class="transition-transform duration-300 group-hover:scale-105"
              />
              <div class="relative flex items-center justify-center px-2">
                <TicketIcon class="text-brand absolute h-8 w-8 opacity-20 transition-transform group-hover:scale-110" />
                <span
                  id="header-participation-count"
                  class="text-brand relative z-10 text-sm font-bold transition-colors group-hover:text-white"
                >
                  {participationCount}
                </span>
              </div>
            </a>
            <div id="participation-tooltip" role="tooltip">
              {participationCount === 0
                ? 'No tienes ninguna participación'
                : participationCount === 1
                  ? 'Tienes 1 participación'
                  : `Tienes ${participationCount} participaciones`}
              <div id="tooltip-arrow" />
            </div>
            <form action="/api/auth/signout" method="post" data-astro-reload>
              <Button
                id="header-logout-btn"
                variant="ghost"
                size="md"
                class="text-white/70 hover:text-white"
                type="submit"
              >
                Cerrar sesión
              </Button>
            </form>
          </div>
        )
      }
    </div>
  </div>

  <div class="logo-container relative mx-auto flex justify-center">
    <div class="logo-wrapper relative z-10 mx-auto max-w-xl w-full px-4 md:px-0">
      <img class="logo-main" src="/logo-a.svg" alt="bigibai logo" />
      <img
        class="pulse absolute top-0 left-0 -z-10 inline-block h-full w-full opacity-50 blur-sm select-none"
        src="/logo-a.svg"
        alt="bigibai logo"
      />
    </div>
  </div>
</header>

<style>
  @keyframes pulse {
    0% {
      opacity: 0.5;
      transform: scale(1);
    }
    50% {
      opacity: 0.75;
      transform: scale(1.02);
    }
    100% {
      opacity: 0.5;
      transform: scale(1);
    }
  }

  @keyframes float {
    0%,
    100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-10px);
    }
  }

  @keyframes glow {
    0%,
    100% {
      opacity: 0.3;
      transform: scale(0.95);
    }
    50% {
      opacity: 0.6;
      transform: scale(1.05);
    }
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(20px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
    }
  }

  .pulse {
    animation: pulse 3s ease-in-out infinite;
  }

  .logo-wrapper {
    position: relative;
    display: inline-block;
  }

  .logo-wrapper::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('/gold-texture.webp');
    background-size: cover;
    background-position: center;
    mask-image: url('/logo-a.svg');
    mask-size: contain;
    mask-repeat: no-repeat;
    mask-position: center;
    pointer-events: none;
    z-index: 2;
  }

  .logo-main {
    display: block;
    width: 100%;
    height: auto;
    opacity: 0;
    visibility: hidden;
  }

  .logo-wrapper {
    animation: float 4s ease-in-out infinite;
    filter: drop-shadow(0 0 20px rgba(248, 177, 52, 0.4));
  }

  .logo-container {
    animation: fadeInScale 0.6s ease-out;
  }

  .glow-effect {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 60%;
    height: 60%;
    background: radial-gradient(circle, rgba(248, 177, 52, 0.4) 0%, transparent 70%);
    filter: blur(40px);
    animation: glow 3s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .fade-in-up {
    animation: fadeInUp 0.3s ease-out;
  }

  #participation-tooltip {
    display: none;
    width: max-content;
    position: absolute;
    top: 0;
    left: 0;
    background: #222;
    color: white;
    font-weight: bold;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 13px;
    z-index: 9999;
    pointer-events: none;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  #tooltip-arrow {
    position: absolute;
    background: #222;
    width: 8px;
    height: 8px;
    transform: rotate(45deg);
  }
</style>

<script>
  import { computePosition, flip, shift, offset, arrow } from '@floating-ui/dom'

  const badge = document.getElementById('participation-badge')
  const tooltip = document.getElementById('participation-tooltip')
  const arrowElement = document.getElementById('tooltip-arrow')

  if (badge && tooltip && arrowElement) {
    function updateTooltip() {
      if (!badge || !tooltip || !arrowElement) return

      computePosition(badge, tooltip, {
        placement: 'bottom',
        middleware: [offset(8), flip(), shift({ padding: 5 }), arrow({ element: arrowElement })],
      }).then(({ x, y, placement, middlewareData }) => {
        if (!tooltip || !arrowElement) return

        Object.assign(tooltip.style, {
          left: `${x}px`,
          top: `${y}px`,
        })

        const { x: arrowX, y: arrowY } = middlewareData.arrow || {}

        const staticSide = {
          top: 'bottom',
          right: 'left',
          bottom: 'top',
          left: 'right',
        }[placement.split('-')[0]]

        Object.assign(arrowElement.style, {
          left: arrowX != null ? `${arrowX}px` : '',
          top: arrowY != null ? `${arrowY}px` : '',
          right: '',
          bottom: '',
          [staticSide as string]: '-4px',
        })
      })
    }

    function showTooltip() {
      if (!tooltip) return
      tooltip.style.display = 'block'
      updateTooltip()
    }

    function hideTooltip() {
      if (!tooltip) return
      tooltip.style.display = 'none'
    }

    ;[
      ['mouseenter', showTooltip],
      ['mouseleave', hideTooltip],
      ['focus', showTooltip],
      ['blur', hideTooltip],
    ].forEach(([event, listener]) => {
      badge.addEventListener(event as string, listener as EventListener)
    })
  }
</script>
