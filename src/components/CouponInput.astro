---
import Button from '@/components/Button.astro'
---

<form id="coupon-form" class="space-y-6">
  <div>
    <label class="sr-only">C贸digo del cup贸n</label>

    <!-- Input oculto para enviar el valor del formulario -->
    <input type="hidden" id="coupon-value" name="coupon" required />

    <!-- Contenedor de los inputs tipo OTP -->
    <div class="flex items-center justify-center gap-1 sm:gap-2 md:gap-3">
      <!-- Primer grupo: XXXX -->
      <div class="flex gap-0.5 sm:gap-1 md:gap-2" data-group="0">
        <input
          type="text"
          maxlength="1"
          data-index="0"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="1"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="2"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="3"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
      </div>

      <!-- Separador -->
      <div class="text-brand text-base font-bold sm:text-lg md:text-xl lg:text-2xl">-</div>

      <!-- Segundo grupo: XXXX -->
      <div class="flex gap-0.5 sm:gap-1 md:gap-2" data-group="1">
        <input
          type="text"
          maxlength="1"
          data-index="4"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="5"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="6"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="7"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
      </div>

      <!-- Separador -->
      <div class="text-brand text-base font-bold sm:text-lg md:text-xl lg:text-2xl">-</div>

      <!-- Tercer grupo: XXXX -->
      <div class="flex gap-0.5 sm:gap-1 md:gap-2" data-group="2">
        <input
          type="text"
          maxlength="1"
          data-index="8"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="9"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="10"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
        <input
          type="text"
          maxlength="1"
          data-index="11"
          autocomplete="off"
          spellcheck="false"
          class="coupon-input border-brand/50 focus:ring-brand focus:border-brand h-8 w-6 rounded-md border-2 bg-black/50 text-center font-mono text-base font-bold text-white uppercase transition-all focus:ring-2 focus:outline-none sm:h-10 sm:w-8 sm:text-lg md:h-12 md:w-10 md:text-xl lg:h-14 lg:w-12 lg:text-2xl"
        />
      </div>
    </div>

    <p class="mt-4 text-center text-xs text-white/50">
      No hace falta introducir el gui贸n, se a帽adir谩 autom谩ticamente
    </p>
  </div>

  <div class="mx-auto w-full max-w-xl">
    <Button type="submit" variant="brand" size="lg" class="w-full"> Validar cup贸n </Button>
  </div>
</form>

<!-- Mensaje de resultado (entre el bot贸n y la caja de ayuda) -->
<div id="message-container" class="mt-4">
  <div
    id="message"
    class="invisible relative mx-auto max-w-xl block translate-y-3 scale-90 cursor-crosshair rounded-lg bg-linear-to-bl from-emerald-400 to-green-500 px-5 py-2 text-center text-sm font-semibold text-white opacity-0 shadow ring-4 shadow-emerald-300 ring-white/20 transition duration-300 hover:scale-105"
  >
  </div>
</div>

<!-- Contenedor con altura animada para evitar layout shift -->
<div id="error-help-wrapper" class="error-help-wrapper">
  <div id="error-help-section" class="error-help-content">
    <div class="error-help-card p-5 md:p-6 rounded-2xl">
      <!-- Header -->
      <div class="flex items-center gap-3 mb-5 pb-4 border-b border-white/10">
        <div class="size-10 rounded-full bg-brand/20 flex items-center justify-center">
          <svg
            class="size-5 text-brand"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2.5"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path>
            <circle cx="12" cy="17" r="0.5" fill="currentColor"></circle>
          </svg>
        </div>
        <div>
          <h3 class="text-white font-bold text-base md:text-lg">
            驴Alg煤n problema? 隆Tranqui, lo solucionamos! 
          </h3>
          <p class="text-white/60 text-xs md:text-sm">
            No te preocupes, tienes hasta el <strong class="text-brand">23 de diciembre</strong> para
            participar
          </p>
        </div>
      </div>

      <!-- Pasos -->
      <div class="space-y-4">
        <div class="flex gap-3">
          <div
            class="shrink-0 size-7 rounded-lg bg-brand text-black font-bold text-sm flex items-center justify-center shadow-lg shadow-brand/30"
          >
            1
          </div>
          <div class="pt-0.5">
            <p class="text-white font-semibold text-sm mb-1">Comprueba el c贸digo</p>
            <p class="text-white/70 text-xs md:text-sm leading-relaxed">
              Es f谩cil confundir caracteres parecidos. Revisa que el n煤mero
              <span
                class="inline-flex items-center justify-center size-5 rounded bg-white/10 font-mono text-brand text-xs font-bold"
                >0</span
              >
              no sea la letra
              <span
                class="inline-flex items-center justify-center size-5 rounded bg-white/10 font-mono text-brand text-xs font-bold"
                >O</span
              >, o que el
              <span
                class="inline-flex items-center justify-center size-5 rounded bg-white/10 font-mono text-brand text-xs font-bold"
                >1</span
              >
              no sea una
              <span
                class="inline-flex items-center justify-center size-5 rounded bg-white/10 font-mono text-brand text-xs font-bold"
                >I</span
              >.
            </p>
          </div>
        </div>

        <div class="flex gap-3">
          <div
            class="shrink-0 size-7 rounded-lg bg-brand text-black font-bold text-sm flex items-center justify-center shadow-lg shadow-brand/30"
          >
            2
          </div>
          <div class="pt-0.5">
            <p class="text-white font-semibold text-sm mb-1">驴Te dice que ya est谩 usado?</p>
            <p class="text-white/70 text-xs md:text-sm leading-relaxed">
              Escr铆benos a
              <a href="mailto:hola@bigibai.com" class="text-brand hover:underline font-semibold"
                >hola@bigibai.com</a
              >
              adjuntando una foto del <strong class="text-white/90">ticket de compra</strong> y del
              <strong class="text-white/90">calendario</strong>. 隆Te ayudamos encantados!
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  import { throwConfetti } from '@/utils/confetti'

  document.addEventListener('astro:page-load', () => {
    const couponInputs = document.querySelectorAll('.coupon-input') as NodeListOf<HTMLInputElement>
    const hiddenInput = document.getElementById('coupon-value') as HTMLInputElement
    const headerParticipationCount = document.getElementById(
      'header-participation-count'
    ) as HTMLDivElement
    const errorHelpWrapper = document.getElementById('error-help-wrapper') as HTMLDivElement

    // Funci贸n para actualizar el valor oculto
    function updateHiddenInput() {
      const values = Array.from(couponInputs).map((input) => input.value)
      const couponValue = `${values.slice(0, 4).join('')}-${values.slice(4, 8).join('')}-${values.slice(8, 12).join('')}`
      hiddenInput.value = couponValue
    }

    // Funci贸n para actualizar el ticket
    function updateTicket(totalCoupons: number) {
      const ticketContent = document.getElementById('ticket-content')
      if (!ticketContent) return

      const ticketCouponCount = document.getElementById('ticket-coupon-count')
      const ticketCouponText = document.getElementById('ticket-coupon-text')

      // Si el usuario tiene cupones
      if (totalCoupons > 0) {
        // Si ya existe el contenido con cupones, solo actualizar los n煤meros
        if (ticketCouponCount && ticketCouponText) {
          ticketCouponCount.textContent = totalCoupons.toString()
          ticketCouponText.textContent = totalCoupons === 1 ? 'participaci贸n' : 'participaciones'
        } else {
          // Si no existe (era el estado sin cupones), reemplazar todo el contenido
          ticketContent.innerHTML = `
            <div class="space-y-2 text-center">
              <p id="participation-status" class="text-lg md:text-xl font-bold text-white/70">
                Ya tienes <span class="text-brand" id="ticket-coupon-count">${totalCoupons}</span> 
                <span id="ticket-coupon-text">${totalCoupons === 1 ? 'participaci贸n' : 'participaciones'}</span>
              </p>
              <p class="text-white/60 text-xs md:text-sm px-2">
                Ingresa un c贸digo arriba para seguir sumando participaciones en el sorteo
              </p>
              <p class="flex items-center justify-center gap-2 text-xs text-brand/80 mx-auto">
                <svg aria-hidden="true" class="h-2.5 w-2.5 animate-bounce" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                </svg>
                <span>Introduce un nuevo c贸digo</span>
              </p>
            </div>
          `
        }
      }
    }

    // Manejar input en cada caja
    couponInputs.forEach((input, index) => {
      input.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement
        let value = target.value.toUpperCase().replace(/[^A-Z0-9]/g, '')

        // Solo permitir un car谩cter
        if (value.length > 1) {
          value = value[0]
        }

        target.value = value

        // Si se ingres贸 un car谩cter, mover al siguiente input
        if (value && index < couponInputs.length - 1) {
          couponInputs[index + 1].focus()
        }

        updateHiddenInput()
      })

      // Manejar backspace
      input.addEventListener('keydown', (e) => {
        const target = e.target as HTMLInputElement

        if (e.key === 'Backspace' && !target.value && index > 0) {
          couponInputs[index - 1].focus()
        }
      })

      // Manejar paste
      input.addEventListener('paste', (e) => {
        e.preventDefault()
        const pastedData = e.clipboardData?.getData('text') || ''
        const cleaned = pastedData.toUpperCase().replace(/[^A-Z0-9]/g, '')

        // Distribuir los caracteres pegados en los inputs
        cleaned.split('').forEach((char, i) => {
          const targetIndex = index + i
          if (targetIndex < couponInputs.length) {
            couponInputs[targetIndex].value = char
          }
        })

        // Mover el foco al siguiente input disponible
        const nextIndex = Math.min(index + cleaned.length, couponInputs.length - 1)
        couponInputs[nextIndex].focus()

        updateHiddenInput()
      })
    })

    // Focus en el primer input al cargar
    if (couponInputs.length > 0) {
      couponInputs[0].focus()
    }

    // Manejar el submit del formulario
    const couponForm = document.getElementById('coupon-form') as HTMLFormElement
    const messageContainer = document.getElementById('message') as HTMLDivElement

    if (couponForm) {
      couponForm.addEventListener('submit', async (e) => {
        e.preventDefault()

        // Ocultar la secci贸n de ayuda al intentar validar
        showErrorHelp(false)

        const couponValue = hiddenInput.value.trim()

        // Validar que el cup贸n est茅 completo
        if (couponValue.length !== 14) {
          // XXXX-XXXX-XXXX = 14 caracteres
          showMessage('Por favor, completa todos los caracteres del cup贸n', true)
          return
        }

        try {
          // Importar actions din谩micamente
          const { actions } = await import('astro:actions')

          // Deshabilitar el bot贸n durante la validaci贸n
          const submitButton = couponForm.querySelector(
            'button[type="submit"]'
          ) as HTMLButtonElement
          if (submitButton) {
            submitButton.disabled = true
            submitButton.textContent = 'Validando...'
          }

          // Llamar a la action
          const { data, error } = await actions.validateCoupon({
            coupon: couponValue,
          })

          if (error) {
            showMessage(error.message || 'Error al validar el cup贸n', true)
          } else if (data) {
            showMessage(data.message || '隆Cup贸n validado correctamente!', false)
            throwConfetti()

            // Mostrar notificaci贸n de logro si se ha conseguido uno nuevo
            if (data.achievement) {
              const { showAchievement } = await import('@/utils/show-achievement')
              showAchievement('achievement-notification', {
                title: data.achievement.title,
                description: data.achievement.description,
                icon: data.achievement.image,
              })
            }

            // Limpiar el formulario
            couponInputs.forEach((input) => {
              input.value = ''
            })
            hiddenInput.value = ''

            // Focus en el primer input
            if (couponInputs.length > 0) {
              couponInputs[0].focus()
            }

            // Actualizar el contador de cupones si existe
            const couponCount = document.getElementById('coupon-count')
            if (couponCount && data.totalCoupons) {
              couponCount.textContent = `Has validado ${data.totalCoupons} ${data.totalCoupons === 1 ? 'cup贸n' : 'cupones'}`
            }

            // Actualizar el contador en el header si existe
            if (headerParticipationCount && data.totalCoupons) {
              headerParticipationCount.textContent = data.totalCoupons.toString()
            }

            // Actualizar el texto del tooltip
            const participationTooltip = document.getElementById('participation-tooltip')
            if (participationTooltip && data.totalCoupons !== undefined) {
              participationTooltip.textContent =
                data.totalCoupons === 1
                  ? `Tienes ${data.totalCoupons} participaci贸n`
                  : `Tienes ${data.totalCoupons} participaciones`
            }

            // Actualizar el ticket
            updateTicket(data.totalCoupons)
          }

          // Rehabilitar el bot贸n
          if (submitButton) {
            submitButton.disabled = false
            submitButton.textContent = 'Validar cup贸n'
          }
        } catch (error) {
          console.error('Error al validar el cup贸n:', error)
          showMessage('Error al validar el cup贸n. Por favor, int茅ntalo de nuevo.', true)

          // Rehabilitar el bot贸n
          const submitButton = couponForm.querySelector(
            'button[type="submit"]'
          ) as HTMLButtonElement
          if (submitButton) {
            submitButton.disabled = false
            submitButton.textContent = 'Validar cup贸n'
          }
        }
      })
    }

    // Funci贸n para mostrar/ocultar la secci贸n de ayuda
    function showErrorHelp(show: boolean) {
      if (!errorHelpWrapper) return

      if (show) {
        errorHelpWrapper.classList.add('is-visible')
      } else {
        errorHelpWrapper.classList.remove('is-visible')
      }
    }

    // Funci贸n para mostrar mensajes
    function showMessage(text: string, isError = false) {
      if (!messageContainer) return

      messageContainer.textContent = text
      messageContainer.classList.remove('invisible', 'opacity-0', 'translate-y-3', 'scale-90')
      messageContainer.classList.add('opacity-100', 'translate-y-0', 'scale-100')

      if (isError) {
        messageContainer.classList.remove(
          'from-emerald-400',
          'to-green-500',
          'shadow-emerald-300',
          'text-white'
        )
        messageContainer.classList.add(
          'from-red-400',
          'to-pink-600',
          'shadow-pink-400',
          'text-white'
        )
        // Mostrar la secci贸n de ayuda cuando hay error
        showErrorHelp(true)
      } else {
        messageContainer.classList.remove(
          'from-red-400',
          'to-pink-600',
          'shadow-pink-400',
          'text-white'
        )
        messageContainer.classList.add(
          'from-emerald-400',
          'to-green-500',
          'shadow-emerald-300',
          'text-white'
        )
        // Ocultar la secci贸n de ayuda cuando hay 茅xito
        showErrorHelp(false)
      }

      // Ocultar el mensaje despu茅s de 5 segundos (pero mantener la ayuda visible)
      setTimeout(() => {
        messageContainer.classList.add('invisible', 'opacity-0', 'translate-y-3', 'scale-90')
        messageContainer.classList.remove('opacity-100', 'translate-y-0', 'scale-100')
      }, 5000)
    }
  })
</script>

<style>
  .coupon-input:focus {
    transform: scale(1.05);
  }

  .coupon-input::placeholder {
    color: rgba(248, 177, 52, 0.3);
  }

  /* Contenedor con animaci贸n de altura sin layout shift */
  .error-help-wrapper {
    display: grid;
    grid-template-rows: 0fr;
    transition: grid-template-rows 0.4s ease-out;
    margin-top: 1.5rem;
  }

  .error-help-wrapper.is-visible {
    grid-template-rows: 1fr;
  }

  .error-help-content {
    overflow: hidden;
  }

  .error-help-content > div {
    opacity: 0;
    transform: translateY(-10px);
    transition:
      opacity 0.3s ease-out 0.1s,
      transform 0.3s ease-out 0.1s;
  }

  .error-help-wrapper.is-visible .error-help-content > div {
    opacity: 1;
    transform: translateY(0);
  }

  /* Estilo tipo BentoCard para la caja de ayuda */
  .error-help-card {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.4) 0%, rgba(0, 41, 107, 0.6) 100%);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow:
      0 10px 40px rgba(0, 0, 0, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }
</style>
