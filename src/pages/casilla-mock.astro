---
import Layout from '@/layouts/Layout.astro'
import Button from '@/components/Button.astro'

const MOCK_DATA = {
  day: 1,
  prize: 'Cirque du Soleil',
  anagram: 'RQEIUC UD LLEOIS',
  answer: 'CIRQUE DU SOLEIL',
  hint: 'Un espect√°culo que desaf√≠a la gravedad y te deja sin aliento',
  videoUrl: '/videos/mock.mp4',
}
---

<Layout title="Casilla Mock - Big Ibai" description="Prototipo del flujo de casillas">
  <div class="flex min-h-screen flex-col">
    <div id="casilla-flow" class="flex-1 relative">
      <canvas id="confetti-canvas" class="confetti-canvas w-full h-full"></canvas>

      <!-- Pantalla 1: Animaci√≥n de apertura con calendario -->
      <div id="screen-opening" class="screen active">
        <div class="opening-animation relative">
          <div class="scene">
            <div class="calendar-wrapper" id="calendarWrapper">
              <img src="/calendar.webp" alt="Calendario" class="bg-image" />
              <div class="grid-layer" id="gridLayer"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pantalla 2: Adivina el premio -->
      <div id="screen-guess" class="screen">
        <div class="screen-content">
          <div class="text-center mb-8">
            <h1
              class="text-4xl md:text-5xl text-brand font-bold mb-4 uppercase"
              style="font-family: 'Heavy', sans-serif; text-shadow: var(--text-shadow-title);"
            >
              ¬°Adivina el premio<br />del d√≠a {MOCK_DATA.day}!
            </h1>
            <p class="text-white/70 text-lg">Resuelve el anagrama para descubrirlo</p>
          </div>

          <div class="chocolate-reveal" id="chocolate-reveal">
            <img
              src="/chocolatinas/1.webp"
              alt="Chocolatina"
              class="chocolate-image floating-chocolate-a"
            />
          </div>

          <div class="flex flex-col gap-4 mt-12 max-w-[320px] mx-auto">
            <Button id="btn-start-game" variant="brand" size="lg" class="w-full">
              ¬°Empezar el reto!
            </Button>

            <Button id="btn-help" variant="secondary" size="lg" class="w-full"> Ver reglas </Button>
          </div>
        </div>
      </div>

      <!-- Pantalla 3: Juego - Anagrama -->
      <div id="screen-game" class="screen p-4!">
        <div class="screen-content game-layout">
          <!-- Columna Izquierda: Juego -->
          <div class="game-column">
            <div id="game-active-content">
              <div class="game-header">
                <div class="timer-display">
                  <div class="text-center">
                    <span id="timer-seconds" class="text-5xl font-bold text-brand">0</span>
                    <span class="text-sm text-white/60 block mt-1">segundos</span>
                  </div>
                </div>
              </div>

              <div class="anagram-container">
                <h2
                  class="text-2xl text-white mb-6 text-center font-bold uppercase"
                  style="font-family: 'Heavy', sans-serif;"
                >
                  Resuelve el anagrama:
                </h2>
                <div class="anagram-letters" id="anagram-letters">
                  {
                    MOCK_DATA.anagram.split('').map((letter, index) => (
                      <span class="anagram-letter" data-index={index} data-letter={letter}>
                        {letter}
                      </span>
                    ))
                  }
                </div>
              </div>

              <div class="answer-input-container">
                <input
                  type="text"
                  id="answer-input"
                  placeholder="Escribe tu respuesta..."
                  maxlength={MOCK_DATA.answer.length}
                  autocomplete="off"
                  class="answer-input"
                />
                <div id="feedback" class="feedback hidden"></div>
              </div>

              <div class="game-actions">
                <Button id="btn-submit" variant="brand" size="lg" class="w-full">
                  Enviar respuesta
                </Button>
              </div>
            </div>

            <!-- Contenido de √©xito (Oculto inicialmente) -->
            <div
              id="game-success-content"
              class="hidden h-full flex flex-col justify-center items-center text-center"
            >
              <h2
                class="text-4xl text-brand font-bold mb-6 uppercase"
                style="font-family: 'Heavy', sans-serif;"
              >
                ¬°Lo conseguiste!
              </h2>
              <p class="text-white text-lg mb-2">Has desvelado el premio del d√≠a:</p>
              <p class="text-3xl text-brand font-bold uppercase mb-8">{MOCK_DATA.prize}</p>

              <div class="bg-black/30 p-4 rounded-lg border border-white/10 mb-6 w-full">
                <p class="text-sm text-white/60 mb-2">
                  * Todos los sorteos se har√°n el 24 de diciembre.
                </p>
                <p class="text-sm text-brand/80 font-bold">
                  Vuelve ma√±ana para desvelar el premio de ma√±ana.
                </p>
              </div>
            </div>
          </div>

          <!-- Columna Derecha: Video Placeholder / Resultado -->
          <div class="video-column">
            <div id="video-placeholder" class="video-placeholder h-full">
              <div class="placeholder-content">
                <span class="text-6xl mb-4">üé¨</span>
                <p class="text-white/60 text-center">Desbloquea el v√≠deo al resolver el anagrama</p>
              </div>
              <video
                id="prize-video"
                class="hidden w-full h-full object-cover rounded-lg"
                playsinline
                muted
                loop
              >
                <source src={MOCK_DATA.videoUrl} type="video/mp4" />
              </video>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal: Reglas -->
      <div id="help-modal" class="modal">
        <div class="modal-content">
          <h3
            class="text-2xl text-brand font-bold mb-4 uppercase"
            style="font-family: 'Heavy', sans-serif;"
          >
            ¬øC√≥mo jugar?
          </h3>
          <ul class="text-white/90 space-y-3 text-left">
            <li>‚Ä¢ Resuelve el anagrama para descubrir el premio del d√≠a</li>
            <li>‚Ä¢ Tienes que usar las letras del anagrama para formar la respuesta</li>
            <li>‚Ä¢ Al resolverlo, desbloqueas un logro</li>
          </ul>
          <Button id="close-help" variant="brand" size="lg" class="w-full mt-6"> Entendido </Button>
        </div>
        <div class="modal-backdrop"></div>
      </div>

      <!-- Notificaci√≥n de Logro (Xbox Style) -->
      <div id="achievement-notification" class="achievement-notification">
        <div class="achievement-icon-container">
          <img src="/achievement_01.webp" alt="Logro" class="achievement-icon" />
        </div>
        <div class="achievement-content">
          <h4 class="achievement-title">¬°Logro desbloqueado!</h4>
          <p class="achievement-text text-balance">
            Completa tu primer anagrama y acierta el premio del d√≠a.
          </p>
        </div>
      </div>
    </div>
  </div>
</Layout>

<style>
  :root {
    /* Variables de ajuste */
    --pad-top: 3%;
    --pad-bottom: 5%;
    --pad-side: 7%;
    --gap-row: 16px;
    --gap-col: 26px;

    /* Variables de animaci√≥n */
    --zoom-scale: 3.5;
    --bg-image: url('/calendar.webp');
  }

  /* Contenedor principal */
  #casilla-flow {
    overflow-y: auto;
    overflow-x: hidden;
  }

  /* Oscurecer el fondo m√°s durante el flujo de casillas */
  #casilla-flow::before {
    content: '';
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.75);
    z-index: -1;
    pointer-events: none;
  }

  /* Pantallas */
  .screen {
    position: absolute;
    inset: 0;
    width: 100%;
    min-height: 100vh;
    min-height: 100dvh;
    display: none;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.5s ease;
    padding: 2rem 0;

    &.opening {
      padding: 0;
    }
  }

  .screen.active {
    display: flex;
    position: relative;
    opacity: 1;
    pointer-events: auto;
  }

  .screen-content {
    max-width: 600px;
    width: 100%;
    margin: 0 auto;
  }

  /* Pantalla 1: Animaci√≥n de apertura */
  .opening-animation {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: visible;
  }

  .confetti-canvas {
    position: absolute;
    inset: 0;
    z-index: 50;
    pointer-events: none;
  }

  .scene {
    position: relative;
    width: 100%;
    max-width: 500px;
    height: auto;
    perspective: 1000px;
    z-index: 2;
  }

  .calendar-wrapper {
    position: relative;
    width: 100%;
    transform-style: preserve-3d;
    transition: transform 1s cubic-bezier(0.25, 1, 0.5, 1);
    cursor: default;
  }

  .calendar-wrapper.shake {
    animation: shake 0.5s cubic-bezier(0.36, 0.07, 0.19, 0.97) infinite;
  }

  .calendar-wrapper.is-zoomed {
    cursor: pointer;
  }

  .bg-image {
    width: 100%;
    display: block;
    border-radius: 10px;
    pointer-events: none;
  }

  .grid-layer {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(6, 1fr);
    padding-top: var(--pad-top);
    padding-bottom: var(--pad-bottom);
    padding-left: var(--pad-side);
    padding-right: var(--pad-side);
    column-gap: var(--gap-col);
    row-gap: var(--gap-row);
    pointer-events: none;
  }

  /* Estilos para las puertas generadas din√°micamente */
  :global(.door-container) {
    position: relative;
    width: 100%;
    height: 100%;
    pointer-events: auto;
    cursor: pointer;
    perspective: 600px;
    transform-style: preserve-3d;
  }

  :global(.door-flipper) {
    position: relative;
    width: 100%;
    height: 100%;
    transform-style: preserve-3d;
    transform-origin: left center;
    transition: transform 0.6s cubic-bezier(0.4, 2, 0.6, 1);
  }

  :global(.door-container.is-open .door-flipper) {
    transform: rotateY(-110deg);
  }

  :global(.door-front) {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 2px;
    background-image: var(--bg-image);
    background-size: 400% 600%;
    color: transparent;
    text-shadow: none;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    font-size: 1.2rem;
    z-index: 2;
    transition:
      color 0.3s ease,
      text-shadow 0.3s ease;
  }

  :global(.door-container:hover .door-front),
  :global(.door-container.is-open .door-front) {
    color: rgba(255, 255, 255, 0.8);
    text-shadow: 0 2px 4px black;
  }

  :global(.door-back) {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    border-radius: 4px;
    background-color: #eaeaea;
    background-image: linear-gradient(to bottom right, #e6e6e6, #f2f2f2);
    border: 1px solid rgba(0, 0, 0, 0.05);
    transform: rotateY(180deg);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  :global(.door-hole) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #1a1a1a;
    border-radius: 4px;
    z-index: 0;
    box-shadow: inset 0 0 10px black;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }

  :global(.door-chocolate) {
    width: 80%;
    height: auto;
    filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
    transform: rotate(-5deg);
  }

  @keyframes fadeInScale {
    from {
      opacity: 0;
      transform: scale(0.8);
    }
    to {
      opacity: 1;
      transform: scale(1);
    }
  }

  /* Chocolate Reveal */
  .chocolate-reveal {
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 2rem 0;
    animation: fadeInScale 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  .chocolate-image {
    width: 120px;
    height: auto;
    filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
    transform: rotate(-5deg);
    transition: transform 0.3s ease;
  }

  @media (min-width: 768px) {
    .chocolate-image {
      width: 250px;
    }
  }

  .chocolate-image:hover {
    transform: rotate(0deg) scale(1.05);
  }

  @keyframes float-a {
    0%,
    100% {
      transform: rotate(-10deg) translateY(0px);
    }
    50% {
      transform: rotate(-5deg) translateY(-20px);
    }
  }

  .floating-chocolate-a {
    animation: float-a 6s ease-in-out infinite;
  }

  /* Pantalla 2: Adivina */
  .prize-teaser {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border: 2px dashed rgba(248, 177, 52, 0.4);
    border-radius: 1rem;
    padding: 3rem 2rem;
    margin: 2rem 0;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  }

  /* Pantalla 3: Juego */
  .game-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: center;
    max-width: 1000px;
  }

  .game-column,
  .video-column {
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(10px);
    border-radius: 1rem;
    padding: 1.5rem;
    border: 2px solid rgba(248, 177, 52, 0.3);
  }

  .video-placeholder {
    aspect-ratio: 9/16;
    background: rgba(0, 0, 0, 0.6);
    border-radius: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px dashed rgba(255, 255, 255, 0.2);
    overflow: hidden;
    position: relative;
  }

  .placeholder-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }

  .game-header {
    margin-bottom: 1.5rem;
  }

  .timer-display {
    display: flex;
    justify-content: center;
    gap: 2rem;
  }

  .anagram-container {
    margin: 1.5rem 0;
  }

  .anagram-letters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
    margin: 1rem 0;
  }

  .anagram-letter {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    background: rgba(248, 177, 52, 0.2);
    border: 2px solid rgba(248, 177, 52, 0.5);
    border-radius: 0.5rem;
    color: var(--color-brand);
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
  }

  .anagram-letter:hover:not(.used) {
    background: rgba(248, 177, 52, 0.3);
    border-color: var(--color-brand);
    transform: scale(1.1);
  }

  .anagram-letter.used {
    opacity: 0.2;
    cursor: default;
    pointer-events: none;
  }

  .answer-input-container {
    margin: 1.5rem 0;
  }

  .answer-input {
    width: 100%;
    padding: 1rem 1.5rem;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(248, 177, 52, 0.4);
    border-radius: 0.75rem;
    color: white;
    font-size: 1.25rem;
    text-align: center;
    text-transform: uppercase;
    transition: all 0.3s ease;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
  }

  .answer-input:focus {
    outline: none;
    border-color: var(--color-brand);
    background: rgba(0, 0, 0, 0.6);
    box-shadow: 0 8px 32px rgba(248, 177, 52, 0.2);
  }

  .answer-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .feedback {
    margin-top: 1rem;
    padding: 1rem;
    border-radius: 0.5rem;
    text-align: center;
    font-weight: bold;
  }

  .feedback.correct {
    background: rgba(92, 137, 72, 0.3);
    color: #6ade6a;
    border: 1px solid #6ade6a;
  }

  .feedback.incorrect {
    background: rgba(220, 38, 38, 0.3);
    color: #fca5a5;
    border: 1px solid #fca5a5;
    animation: shake 0.5s;
  }

  @keyframes shake {
    0% {
      transform: translate(0, 0) rotate(0deg);
    }
    10% {
      transform: translate(-5px, -5px) rotate(-3deg);
    }
    20% {
      transform: translate(5px, 5px) rotate(3deg);
    }
    30% {
      transform: translate(-5px, 5px) rotate(-3deg);
    }
    40% {
      transform: translate(5px, -5px) rotate(3deg);
    }
    50% {
      transform: translate(-5px, -5px) rotate(-3deg);
    }
    60% {
      transform: translate(5px, 5px) rotate(3deg);
    }
    70% {
      transform: translate(-5px, 5px) rotate(-3deg);
    }
    80% {
      transform: translate(5px, -5px) rotate(3deg);
    }
    90% {
      transform: translate(-5px, -5px) rotate(-3deg);
    }
    100% {
      transform: translate(0, 0) rotate(0deg);
    }
  }

  .game-actions {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1.5rem;
  }

  /* Pantalla 4: Video */
  .video-container {
    position: relative;
    margin-bottom: 2rem;
  }

  .video-overlay {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.8);
    padding: 2rem;
    text-align: center;
  }

  .result-section {
    text-align: center;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
    padding: 2rem;
    border-radius: 1rem;
    border: 2px solid rgba(248, 177, 52, 0.3);
  }

  .score-display {
    margin-bottom: 2rem;
  }

  .share-actions {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
  }

  .next-day-message {
    padding: 1rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 0.5rem;
    border: 1px solid rgba(248, 177, 52, 0.2);
  }

  /* Sheet (Pista) */
  .sheet {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 100;
    transform: translateY(100%);
    transition: transform 0.3s ease;
  }

  .sheet.active {
    transform: translateY(0);
  }

  .sheet-content {
    position: relative;
    z-index: 102;
    background: rgba(20, 20, 30, 0.98);
    backdrop-filter: blur(20px);
    border-top-left-radius: 1.5rem;
    border-top-right-radius: 1.5rem;
    border-top: 3px solid rgba(248, 177, 52, 0.4);
    padding: 2rem;
    max-height: 75vh;
    overflow-y: auto;
    box-shadow: 0 -8px 32px rgba(0, 0, 0, 0.5);
  }

  .sheet-handle {
    width: 3rem;
    height: 0.25rem;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 1rem;
    margin: 0 auto 1.5rem;
  }

  .sheet-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 101;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .sheet.active .sheet-backdrop {
    opacity: 1;
    pointer-events: auto;
  }

  /* Modal (Reglas) */
  .modal {
    position: fixed;
    inset: 0;
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 2rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .modal.active {
    opacity: 1;
    pointer-events: auto;
  }

  .modal-content {
    position: relative;
    z-index: 102;
    background: rgba(20, 20, 30, 0.98);
    backdrop-filter: blur(20px);
    border: 2px solid rgba(248, 177, 52, 0.4);
    border-radius: 1rem;
    padding: 2rem;
    max-width: 500px;
    width: 100%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
  }

  .modal-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    z-index: 101;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .game-layout {
      grid-template-columns: 1fr;
    }

    .anagram-letter {
      width: 2.5rem;
      height: 2.5rem;
      font-size: 1.25rem;
    }

    .timer-display {
      gap: 1rem;
      padding: 1rem;
    }

    #timer-seconds {
      font-size: 2.5rem;
    }

    .answer-input {
      font-size: 1rem;
    }
  }

  /* Mejoras de accesibilidad */
  .answer-input:focus-visible {
    outline: 2px solid var(--color-brand);
    outline-offset: 2px;
  }

  /* Achievement Notification */
  .achievement-notification {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(150%);
    background: #1f1f1f;
    border-radius: 50px;
    padding: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.8);
    z-index: 1000;
    border: 2px solid #2c2c2c;
    width: fit-content;
    max-width: 68px;
    height: 68px;
    overflow: hidden;
    transition:
      transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
      max-width 0.8s cubic-bezier(0.4, 0, 0.2, 1),
      padding 0.5s ease,
      gap 0.5s ease;
  }

  .achievement-notification.show {
    transform: translateX(-50%) translateY(0);
  }

  .achievement-notification.expanded {
    max-width: 1000px;
    padding: 0.5rem 2rem 0.5rem 0.5rem;
    gap: 1rem;
  }

  .achievement-icon-container {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    overflow: hidden;
    border: 2px solid #6ade6a;
    flex-shrink: 0;
  }

  .achievement-icon {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .achievement-content {
    display: flex;
    flex-direction: column;
    opacity: 0;
    width: 0;
    white-space: nowrap;
    transition: opacity 0.3s ease 0.2s;
  }

  .achievement-notification.expanded .achievement-content {
    opacity: 1;
    width: auto;
  }

  .achievement-title {
    color: white;
    font-weight: bold;
    font-size: 0.9rem;
    margin: 0;
    text-transform: uppercase;
  }

  .achievement-text {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.75rem;
    margin: 0;
    text-overflow: ellipsis;
    overflow: hidden;
  }
</style>

<script>
  import confetti from 'canvas-confetti'

  const $ = document.querySelector.bind(document)

  // Datos del juego
  const MOCK_DATA = {
    day: 1,
    prize: 'Cirque du Soleil',
    anagram: 'RQEIUC UD LLEOIS',
    answer: 'CIRQUE DU SOLEIL',
    hint: 'Un espect√°culo que desaf√≠a la gravedad y te deja sin aliento',
    videoUrl: '/video-premio-mock.mp4',
  }

  // Configuraci√≥n del calendario
  const doorNumbers = [
    14, 7, 10, 22, 3, 15, 13, 12, 21, 16, 20, 2, 9, 5, 24, 8, 19, 11, 18, 1, 4, 17, 6, 23,
  ]

  // Elementos del DOM
  const screens: Record<string, HTMLElement | null> = {
    opening: $('#screen-opening'),
    guess: $('#screen-guess'),
    game: $('#screen-game'),
    video: $('#screen-video'),
  }

  const gridLayer = $('#gridLayer')
  const wrapper = $('#calendarWrapper')
  let activeDoor: HTMLElement | null = null
  let isZoomed = false

  // Inicializaci√≥n del calendario
  function initCalendar() {
    if (!gridLayer || !wrapper) return

    doorNumbers.forEach((number, index) => {
      const cell = document.createElement('div')
      cell.className = 'door-container'
      cell.id = `door-${index}`

      const holeContent =
        number === 1
          ? `<img src="/chocolatinas/1.webp" class="door-chocolate" alt="Chocolate" />`
          : ''

      cell.innerHTML = `
        <div class="door-hole">${holeContent}</div>
        <div class="door-flipper">
            <div class="door-front">
                <span>${number}</span>
            </div>
            <div class="door-back"></div>
        </div>
      `

      cell.addEventListener('click', (e) => {
        e.stopPropagation()
        handleDoorClick(cell, index)
      })

      gridLayer.appendChild(cell)
    })

    requestAnimationFrame(updateDoorBackgrounds)

    const resizeObserver = new ResizeObserver(() => {
      updateDoorBackgrounds()
    })
    resizeObserver.observe(wrapper)
  }

  function updateDoorBackgrounds() {
    if (!wrapper) return
    const wrapperRect = wrapper.getBoundingClientRect()
    const doors = document.querySelectorAll('.door-front')

    doors.forEach((door) => {
      const doorRect = door.getBoundingClientRect()
      const offsetX = doorRect.left - wrapperRect.left
      const offsetY = doorRect.top - wrapperRect.top

      const doorElement = door as HTMLElement
      doorElement.style.backgroundSize = `${wrapperRect.width}px ${wrapperRect.height}px`
      doorElement.style.backgroundPosition = `-${offsetX}px -${offsetY}px`
    })
  }

  // L√≥gica de ZOOM + CENTRADO
  function handleDoorClick(doorElement: HTMLElement, index: number) {
    if (isZoomed || !wrapper) return

    isZoomed = true
    activeDoor = doorElement

    const rect = doorElement.getBoundingClientRect()
    const wrapperRect = wrapper.getBoundingClientRect()

    const doorCenterX = rect.left + rect.width / 2
    const doorCenterY = rect.top + rect.height / 2

    const targetCenterX = wrapperRect.left + wrapperRect.width / 2
    const targetCenterY = wrapperRect.top + wrapperRect.height / 2

    const originX = doorCenterX - wrapperRect.left
    const originY = doorCenterY - wrapperRect.top
    wrapper.style.transformOrigin = `${originX}px ${originY}px`

    const moveX = targetCenterX - doorCenterX
    const moveY = targetCenterY - doorCenterY

    wrapper.style.transform = `translate(${moveX}px, ${moveY}px) scale(var(--zoom-scale))`
    wrapper.classList.add('is-zoomed')

    setTimeout(() => {
      doorElement.classList.add('is-open')

      setTimeout(() => {
        transitionToScreen('guess')
      }, 1000)
    }, 800)
  }

  // Animaci√≥n inicial autom√°tica
  function startOpeningAnimation() {
    if (!wrapper) return

    const SHAKE_DURATION = 1500

    setTimeout(() => {
      wrapper.classList.add('shake')
      launchChristmasConfetti(SHAKE_DURATION)

      setTimeout(() => {
        wrapper.classList.remove('shake')

        const dayOneIndex = doorNumbers.indexOf(1)
        if (dayOneIndex !== -1) {
          const doorElement = document.getElementById(`door-${dayOneIndex}`)
          if (doorElement) {
            handleDoorClick(doorElement, dayOneIndex)
          }
        }
      }, SHAKE_DURATION)
    }, 500)
  }

  // Estados del juego
  let currentScreen = 'opening'
  let gameTimer: number | null = null
  let elapsedSeconds = 0
  let availableLetters: { letter: string; index: number; used: boolean }[] = []

  const answerInput = document.getElementById('answer-input') as HTMLInputElement | null
  const feedback = document.getElementById('feedback')
  const timerSeconds = document.getElementById('timer-seconds')

  // Configurar canvas de confetti
  const canvas = document.getElementById('confetti-canvas') as HTMLCanvasElement | null
  const myConfetti = canvas
    ? confetti.create(canvas, {
        resize: true,
        useWorker: true,
      })
    : null

  // Funci√≥n para lanzar confetti navide√±o
  function launchChristmasConfetti(duration = 3000) {
    if (!myConfetti) return

    const animationEnd = Date.now() + duration
    const defaults = {
      startVelocity: 30,
      spread: 360,
      ticks: 60,
      zIndex: 1,
    }

    function randomInRange(min: number, max: number) {
      return Math.random() * (max - min) + min
    }

    const interval = setInterval(function () {
      const timeLeft = animationEnd - Date.now()

      if (timeLeft <= 0) {
        return clearInterval(interval)
      }

      const particleCount = 100 * (timeLeft / duration)

      myConfetti({
        ...defaults,
        particleCount,
        origin: { x: 0.5, y: 0.5 },
        colors: ['#ff0000', '#00ff00', '#ffffff', '#FFD700'],
        scalar: 1.2,
      })
    }, 250)
  }

  function launchWinConfetti() {
    if (!myConfetti) return

    const duration = 3000
    const end = Date.now() + duration

    ;(function frame() {
      myConfetti({
        particleCount: 7,
        angle: 60,
        spread: 55,
        origin: { x: 0, y: 1 },
        colors: ['#ff0000', '#00ff00', '#ffffff', '#FFD700'],
      })
      myConfetti({
        particleCount: 7,
        angle: 120,
        spread: 55,
        origin: { x: 1, y: 1 },
        colors: ['#ff0000', '#00ff00', '#ffffff', '#FFD700'],
      })

      if (Date.now() < end) {
        requestAnimationFrame(frame)
      }
    })()
  }

  function transitionToScreen(screenName: string) {
    if (screens[currentScreen]) {
      screens[currentScreen]?.classList.remove('active')
    }

    if (screens[screenName]) {
      screens[screenName]?.classList.add('active')
      currentScreen = screenName

      if (screenName === 'game') {
        startGame()
      }
    }
  }

  // L√≥gica del juego
  function startGame() {
    elapsedSeconds = 0
    updateTimerDisplay()

    availableLetters = MOCK_DATA.anagram.split('').map((letter, index) => ({
      letter: letter.toUpperCase(),
      index,
      used: false,
    }))

    setTimeout(() => {
      answerInput?.focus()
    }, 500)

    if (gameTimer) clearInterval(gameTimer)
    gameTimer = setInterval(() => {
      elapsedSeconds++
      updateTimerDisplay()
    }, 1000) as unknown as number

    setupLetterClickHandlers()
    setupInputValidation()
  }

  function updateTimerDisplay() {
    if (timerSeconds) timerSeconds.textContent = String(elapsedSeconds)
  }

  function stopGame() {
    if (gameTimer) {
      clearInterval(gameTimer)
      gameTimer = null
    }
  }

  function setupLetterClickHandlers() {
    const letterElements = document.querySelectorAll('.anagram-letter')
    letterElements.forEach((el) => {
      el.addEventListener('click', () => {
        const index = parseInt(el.getAttribute('data-index') || '0')
        const letter = availableLetters[index]

        if (!letter.used && answerInput) {
          const currentValue = answerInput.value.toUpperCase()
          answerInput.setAttribute('data-previous-value', currentValue)

          answerInput.value += letter.letter

          letter.used = true
          el.classList.add('used')

          answerInput.setAttribute('data-previous-value', answerInput.value.toUpperCase())
        }
      })
    })
  }

  function setupInputValidation() {
    if (!answerInput) return

    answerInput.setAttribute('data-previous-value', '')

    answerInput.addEventListener('input', (e) => {
      const input = (e.target as HTMLInputElement).value.toUpperCase()
      const previousValue = answerInput.getAttribute('data-previous-value') || ''

      if (input.length > previousValue.length) {
        const newChar = input[input.length - 1]

        const availableLetter = availableLetters.find((l) => l.letter === newChar && !l.used)

        if (availableLetter) {
          availableLetter.used = true
          updateLetterVisuals()
          answerInput.setAttribute('data-previous-value', input)
        } else {
          answerInput.value = previousValue
          return
        }
      } else if (input.length < previousValue.length) {
        const removedChar = previousValue[input.length]

        const usedLetterIndex = availableLetters
          .map((l, idx) => ({ ...l, originalIndex: idx }))
          .reverse()
          .findIndex((l) => l.letter === removedChar && l.used)

        if (usedLetterIndex !== -1) {
          const originalIndex = availableLetters.length - 1 - usedLetterIndex
          availableLetters[originalIndex].used = false
          updateLetterVisuals()
        }

        answerInput.setAttribute('data-previous-value', input)
      }
    })
  }

  function updateLetterVisuals() {
    availableLetters.forEach((letter) => {
      const el = document.querySelector(`[data-index="${letter.index}"]`)
      if (el) {
        if (letter.used) {
          el.classList.add('used')
        } else {
          el.classList.remove('used')
        }
      }
    })
  }

  function checkAnswer() {
    if (!answerInput) return

    const userAnswer = answerInput.value.trim().toUpperCase()
    const correctAnswer = MOCK_DATA.answer

    if (userAnswer === correctAnswer) {
      // Respuesta correcta
      stopGame()
      showFeedback(true, '¬°Correcto!')
      launchWinConfetti()
      showAchievement()

      // Mostrar video y resultado
      const videoPlaceholder = document.getElementById('video-placeholder')
      const placeholderContent = videoPlaceholder?.querySelector('.placeholder-content')
      const video = document.getElementById('prize-video') as HTMLVideoElement | null

      const gameActiveContent = document.getElementById('game-active-content')
      const gameSuccessContent = document.getElementById('game-success-content')

      if (placeholderContent) placeholderContent.classList.add('hidden!')
      if (video) {
        video.classList.remove('hidden')
        video.muted = false
        video.play().catch((e) => console.log('Error reproduciendo video:', e))
      }

      if (gameActiveContent) gameActiveContent.classList.add('hidden')
      if (gameSuccessContent) gameSuccessContent.classList.remove('hidden')
    } else {
      // Respuesta incorrecta
      showFeedback(false, 'Incorrecto, int√©ntalo de nuevo')
      answerInput.value = ''
      answerInput.focus()
    }
  }

  function showFeedback(isCorrect: boolean, message: string) {
    if (!feedback) return

    feedback.textContent = message
    feedback.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`
    feedback.classList.remove('hidden')

    if (!isCorrect) {
      setTimeout(() => {
        feedback.classList.add('hidden')
      }, 2000)
    }
  }

  function showAchievement() {
    const notification = document.getElementById('achievement-notification')
    if (notification) {
      // Reproducir sonido
      const audio = new Audio('/achievement-sound.mp3')
      audio.volume = 0.5
      audio.play().catch((e) => console.log('Error playing sound:', e))

      notification.classList.add('show')

      setTimeout(() => {
        notification.classList.add('expanded')
      }, 600)

      setTimeout(() => {
        notification.classList.remove('expanded')
        setTimeout(() => {
          notification.classList.remove('show')
        }, 500)
      }, 8000)
    }
  }

  // Event Listeners
  document.addEventListener('DOMContentLoaded', () => {
    initCalendar()
    startOpeningAnimation()

    document.getElementById('btn-start-game')?.addEventListener('click', () => {
      transitionToScreen('game')
    })

    document.getElementById('btn-submit')?.addEventListener('click', checkAnswer)

    answerInput?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkAnswer()
    })

    // Sheet de pista
    const sheet = document.getElementById('hint-sheet')
    const backdrop = sheet?.querySelector('.sheet-backdrop')

    function openSheet() {
      sheet?.classList.add('active')
    }

    function closeSheet() {
      sheet?.classList.remove('active')
    }

    document.getElementById('btn-hint')?.addEventListener('click', openSheet)
    document.getElementById('close-hint')?.addEventListener('click', closeSheet)
    backdrop?.addEventListener('click', closeSheet)

    const modal = document.getElementById('help-modal')
    const modalBackdrop = modal?.querySelector('.modal-backdrop')

    function openModal() {
      modal?.classList.add('active')
    }

    function closeModal() {
      modal?.classList.remove('active')
    }

    document.getElementById('btn-help')?.addEventListener('click', openModal)
    document.getElementById('close-help')?.addEventListener('click', closeModal)
    modalBackdrop?.addEventListener('click', closeModal)

    // Audio player mock
    document
      .getElementById('play-audio')
      ?.addEventListener('click', function (this: HTMLButtonElement) {
        const btn = this
        const originalText = btn.textContent
        btn.textContent = 'üîä Reproduciendo...'
        btn.disabled = true

        setTimeout(() => {
          btn.textContent = originalText || ''
          btn.disabled = false
        }, 3000)
      })
  })

  // Cleanup al salir
  window.addEventListener('beforeunload', () => {
    stopGame()
  })
</script>
