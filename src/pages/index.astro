---
import Layout from '@/layouts/Layout.astro'
import Header from '@/sections/Header.astro'
import Hero from '@/sections/Hero.astro'
import Footer from '@/sections/Footer.astro'
import Chocolates from '@/sections/Chocolates.astro'
import Map from '@/components/Map.astro'
import { supabaseAdmin } from '@/supabase-admin'
import Clicker from '@/components/Clicker.astro'

// Verificar si el usuario está logueado
const user = Astro.locals.user

// Si el usuario está logueado, obtener sus cupones y logros en paralelo para reducir latencia
let totalCoupons = 0
let userAchievements = {}

if (user) {
  const [userCouponsResult, achievementsResult] = await Promise.all([
    supabaseAdmin
      .from('coupons')
      .select('used_at')
      .eq('used_by', user.id)
      .eq('is_used', true),
    supabaseAdmin
      .from('user_achievements')
      .select('achievements')
      .eq('user_id', user.id)
      .maybeSingle(),
  ])

  totalCoupons = userCouponsResult.data?.length ?? 0
  userAchievements = achievementsResult.data?.achievements ?? {}
}
---

<Layout>
  <div class="flex min-h-screen flex-col">
    <Header participationCount={totalCoupons} />
    <div class="flex flex-1">
      <Hero
        isLoggedIn={!!user}
        participationCount={totalCoupons}
        userAchievements={userAchievements}
      />
    </div>

    <!-- Sección con juego de clicker -->
    <section id="clicker" class="mx-auto w-full max-w-7xl px-4 py-4 pb-24">
      <div class="mb-8 text-center">
        <h2 class="text-shadow-title text-3xl font-bold text-white md:text-4xl lg:text-5xl">
          Juego de clicker
        </h2>
        <p class="text-shadow-title text-white mb-4">
          Si has llegado hasta aquí, te has ganado una recompensa
        </p>
      </div>
      <div class="flex justify-center">
        <Clicker />
      </div>
    </section>

    <Footer />
  </div>
</Layout>
