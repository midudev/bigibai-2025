---
import Layout from '@/layouts/Layout.astro'
import Header from '@/sections/Header.astro'
import Hero from '@/sections/Hero.astro'
import Footer from '@/sections/Footer.astro'
import Chocolates from '@/sections/Chocolates.astro'
import Map from '@/components/Map.astro'
import { supabaseAdmin } from '@/supabase-admin'
import Clicker from '@/components/Clicker.astro'

// Verificar si el usuario está logueado
const user = Astro.locals.user

// Si el usuario está logueado, obtener sus cupones
let totalCoupons = 0
if (user) {
  const { data: userCoupons } = await supabaseAdmin
    .from('coupons')
    .select('used_at')
    .eq('used_by', user.id)
    .eq('is_used', true)

  totalCoupons = userCoupons?.length || 0
}
---

<Layout>
  <div class="flex min-h-screen flex-col">
    <Header participationCount={totalCoupons} />
    <div class="flex flex-1">
      <Hero isLoggedIn={!!user} participationCount={totalCoupons} />
    </div>

    <Chocolates />

    <!-- Sección de tiendas con el mapa -->
    <section id="tiendas" class="mx-auto w-full max-w-7xl px-4 py-12 md:py-20">
      <div class="mb-8 text-center">
        <h2 class="text-shadow-title text-3xl font-bold text-white md:text-4xl lg:text-5xl mb-4">
          ¿Dónde puedo comprar el calendario?
        </h2>
      </div>
      <Map />
    </section>

    <!-- Sección con juego de clicker -->
    <section id="clicker" class="mx-auto w-full max-w-7xl px-4 py-12 md:py-20">
      <div class="mb-8 text-center">
        <h2 class="text-shadow-title text-3xl font-bold text-white md:text-4xl lg:text-5xl mb-4">
          Juego de clicker
        </h2>
        <p class="text-shadow-title text-white mb-4">
          Si has llegado hasta aquí, te has ganado una recompensa
        </p>
      </div>
      <div class="flex justify-center">
        <Clicker />
      </div>
    </section>

    <Footer />
  </div>
</Layout>
