---
import Layout from '@/layouts/Layout.astro'
import Header from '@/sections/Header.astro'
import BentoCard from '@/components/ui/BentoCard.astro'
import Button from '@/components/Button.astro'
import { supabaseAdmin } from '@/supabase-admin'
import { isAdmin } from '@/utils/admin'

// Verificar que el usuario est√© autenticado
if (!Astro.locals.user) {
  return Astro.redirect('/404')
}

// Verificar que el email del usuario est√© en la lista de admins
const userId = Astro.locals.user.id
if (!isAdmin(userId)) {
  return Astro.redirect('/404')
}

// Obtener estad√≠sticas generales en paralelo
const [
  { count: totalCouponsUsed },
  { data: uniqueUsersCount },
  { data: averageCouponsPerUser },
  { data: userCoupons },
] = await Promise.all([
  // 1. Total de cupones usados
  supabaseAdmin.from('coupons').select('*', { count: 'exact', head: true }).eq('is_used', true),

  // 2. Total de usuarios con cupones
  supabaseAdmin.rpc('total_unique_users_with_coupons'),

  // 3. Calcular media de cupones por usuario
  supabaseAdmin.rpc('avg_coupons_per_user'),

  // 4. Obtener cupones del usuario actual para el header
  supabaseAdmin
    .from('coupons')
    .select('used_at')
    .eq('used_by', Astro.locals.user.id)
    .eq('is_used', true),
])

const totalUserCoupons = userCoupons?.length || 0

// Calcular porcentaje de cupones reclamados
const totalCouponsAvailable = parseInt(import.meta.env.TOTAL_COUPONS || '0')
const claimedPercentage =
  totalCouponsAvailable > 0
    ? (((totalCouponsUsed || 0) / totalCouponsAvailable) * 100).toFixed(1)
    : '0.0'
---

<Layout title="Panel de Administraci√≥n - Big Ibai 2025">
  <div class="flex min-h-screen flex-col">
    <Header participationCount={totalUserCoupons} />

    <main class="mx-auto w-full max-w-7xl flex-1 px-4 py-12 md:py-20">
      <div class="space-y-8">
        <!-- Encabezado -->
        <div class="text-center">
          <h1 class="text-shadow-title text-4xl font-bold text-white md:text-5xl lg:text-6xl">
            Panel de Administraci√≥n
          </h1>
          <p class="mt-4 text-lg text-white/80 md:text-xl">
            Bienvenido, {Astro.locals.user.user_metadata.full_name}
          </p>
        </div>

        <!-- Estad√≠sticas generales -->
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-4">
          <!-- Total de usuarios -->
          <BentoCard class="group overflow-hidden" style="animation-delay: 0.1s;">
            <div class="flex flex-col items-center justify-center p-8 text-center">
              <div class="mb-4 text-6xl">üë•</div>
              <h3 class="text-shadow-title text-2xl font-bold text-white md:text-3xl">
                {uniqueUsersCount}
              </h3>
              <p class="mt-2 text-white/80">Usuarios con cupones</p>
            </div>
          </BentoCard>

          <!-- Cupones usados -->
          <BentoCard class="group overflow-hidden" style="animation-delay: 0.2s;">
            <div class="flex flex-col items-center justify-center p-8 text-center">
              <div class="mb-4 text-6xl">üéüÔ∏è</div>
              <h3 class="text-shadow-title text-2xl font-bold text-white md:text-3xl">
                {totalCouponsUsed || 0}
              </h3>
              <p class="mt-2 text-white/80">Cupones usados</p>
            </div>
          </BentoCard>

          <!-- Media de cupones por usuario -->
          <BentoCard class="group overflow-hidden" style="animation-delay: 0.3s;">
            <div class="flex flex-col items-center justify-center p-8 text-center">
              <div class="mb-4 text-6xl">üìä</div>
              <h3 class="text-shadow-title text-2xl font-bold text-white md:text-3xl">
                {averageCouponsPerUser.toFixed(2)}
              </h3>
              <p class="mt-2 text-white/80">Media cupones/usuario</p>
            </div>
          </BentoCard>

          <!-- Porcentaje de cupones reclamados -->
          <BentoCard class="group overflow-hidden" style="animation-delay: 0.4s;">
            <div class="flex flex-col items-center justify-center p-8 text-center">
              <div class="mb-4 text-6xl">üìà</div>
              <h3 class="text-shadow-title text-2xl font-bold text-white md:text-3xl">
                {claimedPercentage}%
              </h3>
              <p class="mt-2 text-white/80">Cupones reclamados</p>
            </div>
          </BentoCard>
        </div>

        <!-- Grid de b√∫squedas -->
        <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
          <!-- Secci√≥n de validaci√≥n de cupones -->
          <BentoCard class="overflow-hidden" style="animation-delay: 0.5s;">
            <div class="p-8">
              <h2 class="text-shadow-title mb-6 text-center text-3xl font-bold text-white">
                Validar Cup√≥n
              </h2>
              <p class="mb-6 text-center text-white/80">
                Introduce el c√≥digo de un cup√≥n para verificar si ha sido usado
              </p>

              <form id="coupon-validation-form" class="mx-auto max-w-md space-y-4">
                <div>
                  <input
                    type="text"
                    id="coupon-input"
                    name="coupon"
                    placeholder="C√≥digo del cup√≥n"
                    class="w-full rounded-lg border border-white/20 bg-black/30 px-4 py-3 text-white placeholder-white/50 backdrop-blur-sm focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/50"
                    required
                  />
                </div>

                <Button type="submit" variant="brand" size="lg" class="w-full">
                  Validar Cup√≥n
                </Button>
              </form>

              <!-- Resultado de la b√∫squeda -->
              <div id="coupon-result" class="mt-6">
                <!-- Loading -->
                <div
                  id="coupon-loading"
                  class="hidden rounded-lg bg-white/5 p-6 text-center backdrop-blur-sm"
                >
                  <div class="mb-4 text-4xl">‚è≥</div>
                  <p class="text-white/80">Buscando cup√≥n...</p>
                </div>

                <!-- Error -->
                <div
                  id="coupon-error"
                  class="hidden rounded-lg bg-red-500/20 p-6 backdrop-blur-sm border border-red-500/30"
                >
                  <div class="mb-4 text-center text-4xl">‚ùå</div>
                  <p id="coupon-error-message" class="text-center text-white font-bold"></p>
                </div>

                <!-- Cup√≥n no usado -->
                <div
                  id="coupon-unused"
                  class="hidden rounded-lg bg-yellow-500/20 p-6 backdrop-blur-sm border border-yellow-500/30"
                >
                  <div class="mb-4 text-center text-4xl">‚ö†Ô∏è</div>
                  <h3 class="mb-2 text-center text-xl font-bold text-white">Cup√≥n no usado</h3>
                  <p class="text-center text-white/80">
                    Este cup√≥n existe pero a√∫n no ha sido utilizado
                  </p>
                  <div class="mt-4 text-center">
                    <p class="text-sm text-white/60">ID: <span id="coupon-unused-id"></span></p>
                  </div>
                </div>

                <!-- Cup√≥n usado -->
                <div
                  id="coupon-used"
                  class="hidden rounded-lg bg-green-500/20 p-6 backdrop-blur-sm border border-green-500/30"
                >
                  <div class="mb-4 text-center text-4xl">‚úÖ</div>
                  <h3 class="mb-4 text-center text-xl font-bold text-white">Cup√≥n usado</h3>

                  <div class="space-y-3 text-white/90">
                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">ID del cup√≥n:</span>
                      <span id="coupon-used-id" class="font-mono text-sm"></span>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Estado:</span>
                      <span id="coupon-reactivable-badge"></span>
                    </div>

                    <div id="coupon-is-duplicate-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Tipo:</span>
                        <span
                          class="inline-flex items-center gap-1 text-xs font-medium px-2 py-1 rounded-md bg-blue-500/20 text-blue-400 border border-blue-500/30"
                        >
                          üìã Uso duplicado
                        </span>
                      </div>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Usuario ID:</span>
                      <span id="coupon-used-by" class="font-mono text-sm"></span>
                    </div>

                    <div id="coupon-used-email-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Email:</span>
                        <span id="coupon-used-email" class="text-sm"></span>
                      </div>
                    </div>

                    <div id="coupon-used-name-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Nombre:</span>
                        <span id="coupon-used-name" class="text-sm"></span>
                      </div>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Usado el:</span>
                      <span id="coupon-used-date" class="text-sm"></span>
                    </div>

                    <div id="coupon-used-ip-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">IP:</span>
                        <span id="coupon-used-ip" class="font-mono text-sm"></span>
                      </div>
                    </div>

                    <div id="coupon-used-location-row" class="hidden">
                      <div class="flex justify-between pb-2">
                        <span class="font-semibold">Ubicaci√≥n:</span>
                        <div class="flex flex-col items-end">
                          <span id="coupon-used-location" class="text-sm"></span>
                          <span class="text-xs text-white/50 italic">(aproximada)</span>
                        </div>
                      </div>
                    </div>

                    <!-- Informaci√≥n del uso original (si es duplicado) -->
                    <div
                      id="coupon-original-usage"
                      class="hidden mt-4 pt-4 border-t border-white/20"
                    >
                      <h4 class="text-sm font-semibold text-white/80 mb-3">
                        Primer uso del cup√≥n:
                      </h4>
                      <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                          <span class="text-white/60">Usuario ID:</span>
                          <span id="coupon-original-user" class="font-mono text-xs"></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-white/60">Fecha:</span>
                          <span id="coupon-original-date" class="text-xs"></span>
                        </div>
                        <div class="flex justify-between">
                          <span class="text-white/60">IP:</span>
                          <span id="coupon-original-ip" class="font-mono text-xs"></span>
                        </div>
                      </div>
                    </div>

                    <!-- Acciones del cup√≥n -->
                    <div id="coupon-actions" class="mt-4 pt-4 border-t border-white/20 hidden">
                      <div class="flex flex-col gap-2">
                        <Button
                          id="mark-reactivable-btn"
                          variant="destructive"
                          size="md"
                          class="w-full"
                        >
                          ‚ö†Ô∏è Marcar como reactivable
                        </Button>
                        <p id="reactivable-status" class="text-xs text-white/60 text-center hidden">
                          ‚úì Este cup√≥n puede ser usado de nuevo por cualquier usuario
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </BentoCard>

          <!-- Secci√≥n de b√∫squeda de usuario -->
          <BentoCard class="overflow-hidden" style="animation-delay: 0.6s;">
            <div class="p-8">
              <h2 class="text-shadow-title mb-6 text-center text-3xl font-bold text-white">
                Buscar Usuario
              </h2>
              <p class="mb-6 text-center text-white/80">
                Introduce el email o ID de un usuario para ver su informaci√≥n
              </p>

              <form id="user-search-form" class="mx-auto max-w-md space-y-4">
                <div>
                  <input
                    type="text"
                    id="user-query-input"
                    name="query"
                    placeholder="Email o ID del usuario"
                    class="w-full rounded-lg border border-white/20 bg-black/30 px-4 py-3 text-white placeholder-white/50 backdrop-blur-sm focus:border-brand focus:outline-none focus:ring-2 focus:ring-brand/50"
                    required
                  />
                </div>

                <Button type="submit" variant="brand" size="lg" class="w-full">
                  Buscar Usuario
                </Button>
              </form>

              <!-- Resultado de la b√∫squeda -->
              <div id="user-result" class="mt-6">
                <!-- Loading -->
                <div
                  id="user-loading"
                  class="hidden rounded-lg bg-white/5 p-6 text-center backdrop-blur-sm"
                >
                  <div class="mb-4 text-4xl">‚è≥</div>
                  <p class="text-white/80">Buscando usuario...</p>
                </div>

                <!-- Error -->
                <div
                  id="user-error"
                  class="hidden rounded-lg bg-red-500/20 p-6 backdrop-blur-sm border border-red-500/30"
                >
                  <div class="mb-4 text-center text-4xl">‚ùå</div>
                  <p id="user-error-message" class="text-center text-white font-bold"></p>
                </div>

                <!-- Usuario encontrado -->
                <div
                  id="user-found"
                  class="hidden rounded-lg bg-blue-500/20 p-6 backdrop-blur-sm border border-blue-500/30"
                >
                  <div class="mb-4 text-center text-4xl">üë§</div>
                  <h3 class="mb-4 text-center text-xl font-bold text-white">Usuario encontrado</h3>

                  <div class="space-y-3 text-white/90">
                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">ID:</span>
                      <span id="user-id" class="font-mono text-sm"></span>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Email:</span>
                      <span id="user-email" class="text-sm"></span>
                    </div>

                    <div id="user-name-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Nombre:</span>
                        <span id="user-name" class="text-sm"></span>
                      </div>
                    </div>

                    <div id="user-provider-row" class="hidden">
                      <div class="flex justify-between border-b border-white/10 pb-2">
                        <span class="font-semibold">Proveedor:</span>
                        <span id="user-provider" class="text-sm"></span>
                      </div>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">Creado:</span>
                      <span id="user-created" class="text-sm"></span>
                    </div>

                    <div class="flex justify-between border-b border-white/10 pb-2">
                      <span class="font-semibold">√öltimo acceso:</span>
                      <span id="user-last-signin" class="text-sm"></span>
                    </div>

                    <div class="flex justify-between pb-2">
                      <span class="font-semibold">Email verificado:</span>
                      <span id="user-email-verified" class="text-sm"></span>
                    </div>
                  </div>

                  <!-- Cupones del usuario -->
                  <div id="user-coupons-section" class="mt-4 border-t border-white/20 pt-4">
                    <h4 class="mb-3 text-center font-semibold text-white">
                      Cupones usados (<span id="user-coupons-count">0</span>)
                    </h4>
                    <div id="user-coupons-list" class="max-h-60 space-y-2 overflow-y-auto">
                      <!-- Los cupones se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    <div id="user-no-coupons" class="hidden text-center">
                      <p class="text-white/60">No ha usado ning√∫n cup√≥n</p>
                    </div>
                  </div>

                  <!-- Logros del usuario -->
                  <div id="user-achievements-section" class="mt-4 border-t border-white/20 pt-4">
                    <h4 class="mb-3 text-center font-semibold text-white">Logros del usuario</h4>
                    <div id="user-achievements-loading" class="hidden text-center py-4">
                      <p class="text-white/60">Cargando logros...</p>
                    </div>
                    <div
                      id="user-achievements-list"
                      class="grid grid-cols-2 gap-3 max-h-96 overflow-y-auto"
                    >
                      <!-- Los logros se agregar√°n aqu√≠ din√°micamente -->
                    </div>
                    <div id="user-no-achievements" class="hidden text-center py-4">
                      <p class="text-white/60">No hay logros disponibles</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </BentoCard>
        </div>
      </div>
    </main>
  </div>
</Layout>

<script>
  const $ = document.querySelector.bind(document)
  const form = $('#coupon-validation-form') as HTMLFormElement
  const couponInput = $('#coupon-input') as HTMLInputElement

  // Elementos para cup√≥n
  const couponLoading = $('#coupon-loading') as HTMLDivElement
  const couponError = $('#coupon-error') as HTMLDivElement
  const couponErrorMessage = $('#coupon-error-message') as HTMLParagraphElement
  const couponUnused = $('#coupon-unused') as HTMLDivElement
  const couponUnusedId = $('#coupon-unused-id') as HTMLSpanElement
  const couponUsed = $('#coupon-used') as HTMLDivElement
  const couponUsedId = $('#coupon-used-id') as HTMLSpanElement
  const couponUsedBy = $('#coupon-used-by') as HTMLSpanElement
  const couponUsedEmailRow = $('#coupon-used-email-row') as HTMLDivElement
  const couponUsedEmail = $('#coupon-used-email') as HTMLSpanElement
  const couponUsedNameRow = $('#coupon-used-name-row') as HTMLDivElement
  const couponUsedName = $('#coupon-used-name') as HTMLSpanElement
  const couponUsedDate = $('#coupon-used-date') as HTMLSpanElement
  const couponUsedIpRow = $('#coupon-used-ip-row') as HTMLDivElement
  const couponUsedIp = $('#coupon-used-ip') as HTMLSpanElement
  const couponUsedLocationRow = $('#coupon-used-location-row') as HTMLDivElement
  const couponUsedLocation = $('#coupon-used-location') as HTMLSpanElement
  const couponReactivableBadge = $('#coupon-reactivable-badge') as HTMLSpanElement
  const couponIsDuplicateRow = $('#coupon-is-duplicate-row') as HTMLDivElement
  const couponOriginalUsage = $('#coupon-original-usage') as HTMLDivElement
  const couponOriginalUser = $('#coupon-original-user') as HTMLSpanElement
  const couponOriginalDate = $('#coupon-original-date') as HTMLSpanElement
  const couponOriginalIp = $('#coupon-original-ip') as HTMLSpanElement
  const couponActions = $('#coupon-actions') as HTMLDivElement
  const markReactivableBtn = $('#mark-reactivable-btn') as HTMLButtonElement
  const reactivableStatus = $('#reactivable-status') as HTMLParagraphElement

  // Variable para almacenar el ID del cup√≥n actual
  let currentCouponId: string | null = null

  // Funci√≥n para ocultar todos los estados de cup√≥n
  function hideAllCouponStates() {
    couponLoading.classList.add('hidden')
    couponError.classList.add('hidden')
    couponUnused.classList.add('hidden')
    couponUsed.classList.add('hidden')
    couponUsedIpRow.classList.add('hidden')
    couponUsedLocationRow.classList.add('hidden')
    couponActions.classList.add('hidden')
    currentCouponId = null
  }

  // Funci√≥n para obtener la ubicaci√≥n de una IP
  async function getIpLocation(ip: string): Promise<string | null> {
    try {
      const response = await fetch(`https://free.freeipapi.com/api/json/${ip}`)
      if (!response.ok) return null

      const data = await response.json()
      const locationParts: string[] = []

      if (data.cityName) locationParts.push(data.cityName)
      if (data.regionName) locationParts.push(data.regionName)
      if (data.countryName) locationParts.push(data.countryName)

      return locationParts.length > 0 ? locationParts.join(', ') : null
    } catch (error) {
      console.error('Error obteniendo ubicaci√≥n de IP:', error)
      return null
    }
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const coupon = couponInput.value.trim()
    if (!coupon) return

    // Mostrar loading
    hideAllCouponStates()
    couponLoading.classList.remove('hidden')

    try {
      const response = await fetch(
        `/api/admin/validate-coupon?coupon=${encodeURIComponent(coupon)}`
      )
      const data = await response.json()

      hideAllCouponStates()

      if (!response.ok) {
        // Mostrar error
        couponErrorMessage.textContent = data.error || 'Error al buscar el cup√≥n'
        couponError.classList.remove('hidden')
        return
      }

      if (!data.is_used) {
        // Mostrar cup√≥n no usado
        couponUnusedId.textContent = String(data.id || '')
        couponUnused.classList.remove('hidden')
      } else {
        // Mostrar cup√≥n usado
        const usedDate = new Date(data.used_at)
        const formattedDate = usedDate.toLocaleString('es-ES', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit',
        })

        couponUsedId.textContent = String(data.id || '')
        couponUsedBy.textContent = String(data.used_by || '')
        couponUsedDate.textContent = formattedDate

        // Mostrar u ocultar campos opcionales
        if (data.user_email) {
          couponUsedEmail.textContent = String(data.user_email)
          couponUsedEmailRow.classList.remove('hidden')
        } else {
          couponUsedEmailRow.classList.add('hidden')
        }

        if (data.user_name) {
          couponUsedName.textContent = String(data.user_name)
          couponUsedNameRow.classList.remove('hidden')
        } else {
          couponUsedNameRow.classList.add('hidden')
        }

        if (data.used_ip) {
          couponUsedIp.textContent = String(data.used_ip)
          couponUsedIpRow.classList.remove('hidden')

          // Obtener y mostrar la ubicaci√≥n de la IP
          couponUsedLocation.textContent = 'Cargando...'
          couponUsedLocationRow.classList.remove('hidden')

          const location = await getIpLocation(data.used_ip)
          if (location) {
            couponUsedLocation.textContent = location
          } else {
            couponUsedLocationRow.classList.add('hidden')
          }
        } else {
          couponUsedIpRow.classList.add('hidden')
          couponUsedLocationRow.classList.add('hidden')
        }

        // Mostrar si es un duplicado
        if (data.is_duplicate) {
          couponIsDuplicateRow.classList.remove('hidden')

          // Mostrar informaci√≥n del uso original
          if (data.original_usage) {
            couponOriginalUser.textContent = data.original_usage.used_by || 'N/A'
            couponOriginalDate.textContent = data.original_usage.used_at
              ? new Date(data.original_usage.used_at).toLocaleString('es-ES')
              : 'N/A'
            couponOriginalIp.textContent = data.original_usage.used_ip || 'N/A'
            couponOriginalUsage.classList.remove('hidden')
          }
        } else {
          couponIsDuplicateRow.classList.add('hidden')
          couponOriginalUsage.classList.add('hidden')
        }

        // Mostrar estado de reactivable
        if (data.is_reactivable) {
          couponReactivableBadge.innerHTML =
            '<span class="inline-flex items-center gap-1 text-xs font-medium px-2 py-1 rounded-md bg-green-500/20 text-green-400 border border-green-500/30">‚úì Reactivable</span>'
        } else if (data.is_duplicate) {
          couponReactivableBadge.innerHTML =
            '<span class="inline-flex items-center gap-1 text-xs font-medium px-2 py-1 rounded-md bg-blue-500/20 text-blue-400 border border-blue-500/30">Reusado</span>'
        } else {
          couponReactivableBadge.innerHTML =
            '<span class="inline-flex items-center gap-1 text-xs font-medium px-2 py-1 rounded-md bg-red-500/20 text-red-400 border border-red-500/30">Usado</span>'
        }

        // Configurar acciones del cup√≥n (solo para cupones no duplicados)
        currentCouponId = String(data.id || '')
        if (data.is_duplicate) {
          // Si es un duplicado, no mostrar acciones
          couponActions.classList.add('hidden')
        } else {
          if (data.is_reactivable) {
            markReactivableBtn.disabled = true
            markReactivableBtn.classList.add('opacity-50', 'cursor-not-allowed')
            reactivableStatus.classList.remove('hidden')
          } else {
            markReactivableBtn.disabled = false
            markReactivableBtn.classList.remove('opacity-50', 'cursor-not-allowed')
            reactivableStatus.classList.add('hidden')
          }
          couponActions.classList.remove('hidden')
        }

        couponUsed.classList.remove('hidden')
      }
    } catch (error) {
      console.error('Error:', error)
      hideAllCouponStates()
      couponErrorMessage.textContent = 'Error al validar el cup√≥n. Int√©ntalo de nuevo m√°s tarde.'
      couponError.classList.remove('hidden')
    }
  })

  // Event listener para marcar cup√≥n como reactivable
  markReactivableBtn?.addEventListener('click', async () => {
    if (!currentCouponId) return

    const originalText = markReactivableBtn.textContent
    markReactivableBtn.disabled = true
    markReactivableBtn.textContent = 'Marcando...'

    try {
      const response = await fetch('/api/admin/mark-coupon-reactivable', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ couponId: currentCouponId }),
      })

      const data = await response.json()

      if (!response.ok) {
        alert(`Error: ${data.error || 'No se pudo marcar el cup√≥n como reactivable'}`)
        markReactivableBtn.disabled = false
        markReactivableBtn.textContent = originalText
        return
      }

      // Actualizar UI
      markReactivableBtn.disabled = true
      markReactivableBtn.classList.add('opacity-50', 'cursor-not-allowed')
      markReactivableBtn.textContent = originalText
      reactivableStatus.classList.remove('hidden')

      // Actualizar badge de estado
      couponReactivableBadge.innerHTML =
        '<span class="inline-flex items-center gap-1 text-xs font-medium px-2 py-1 rounded-md bg-green-500/20 text-green-400 border border-green-500/30">‚úì Reactivable</span>'
    } catch (error) {
      console.error('Error al marcar cup√≥n como reactivable:', error)
      alert('Error al marcar el cup√≥n como reactivable. Int√©ntalo de nuevo.')
      markReactivableBtn.disabled = false
      markReactivableBtn.textContent = originalText
    }
  })

  // Script para b√∫squeda de usuario
  const userForm = $('#user-search-form') as HTMLFormElement
  const queryInput = $('#user-query-input') as HTMLInputElement

  // Elementos para usuario
  const userLoading = $('#user-loading') as HTMLDivElement
  const userError = $('#user-error') as HTMLDivElement
  const userErrorMessage = $('#user-error-message') as HTMLParagraphElement
  const userFound = $('#user-found') as HTMLDivElement
  const userId = $('#user-id') as HTMLSpanElement
  const userEmail = $('#user-email') as HTMLSpanElement
  const userNameRow = $('#user-name-row') as HTMLDivElement
  const userName = $('#user-name') as HTMLSpanElement
  const userProviderRow = $('#user-provider-row') as HTMLDivElement
  const userProvider = $('#user-provider') as HTMLSpanElement
  const userCreated = $('#user-created') as HTMLSpanElement
  const userLastSignin = $('#user-last-signin') as HTMLSpanElement
  const userEmailVerified = $('#user-email-verified') as HTMLSpanElement
  const userCouponsCount = $('#user-coupons-count') as HTMLSpanElement
  const userCouponsList = $('#user-coupons-list') as HTMLDivElement
  const userNoCoupons = $('#user-no-coupons') as HTMLDivElement

  // Funci√≥n para ocultar todos los estados de usuario
  function hideAllUserStates() {
    userLoading.classList.add('hidden')
    userError.classList.add('hidden')
    userFound.classList.add('hidden')
  }

  userForm?.addEventListener('submit', async (e) => {
    e.preventDefault()

    const query = queryInput.value.trim()
    if (!query) return

    // Mostrar loading
    hideAllUserStates()
    userLoading.classList.remove('hidden')

    try {
      const response = await fetch(`/api/admin/search-user?query=${encodeURIComponent(query)}`)
      const data = await response.json()

      hideAllUserStates()

      if (!response.ok) {
        // Mostrar error
        userErrorMessage.textContent = data.error || 'Error al buscar el usuario'
        userError.classList.remove('hidden')
        return
      }

      // Formatear fechas
      const createdDate = new Date(data.created_at)
      const formattedCreatedDate = createdDate.toLocaleString('es-ES', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      })

      const lastSignIn = data.last_sign_in_at
        ? new Date(data.last_sign_in_at).toLocaleString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          })
        : 'Nunca'

      // Actualizar datos del usuario
      userId.textContent = String(data.id || '')
      userEmail.textContent = String(data.email || '')
      userCreated.textContent = formattedCreatedDate
      userLastSignin.textContent = lastSignIn
      userEmailVerified.textContent = data.email_confirmed_at ? '‚úÖ S√≠' : '‚ùå No'

      // Mostrar u ocultar campos opcionales
      if (data.name) userName.textContent = String(data.name)
      userNameRow.classList.toggle('hidden', !data.name)

      if (data.provider) userProvider.textContent = String(data.provider)
      userProviderRow.classList.toggle('hidden', !data.provider)

      // Manejar cupones
      userCouponsList.innerHTML = '' // Limpiar lista anterior

      if (data.coupons && data.coupons.length > 0) {
        userCouponsCount.textContent = String(data.coupons.length)
        userNoCoupons.classList.add('hidden')

        // Crear elementos de cupones de forma segura
        data.coupons.forEach((coupon: any) => {
          const usedDate = new Date(coupon.used_at).toLocaleString('es-ES', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
          })

          const couponDiv = document.createElement('div')
          couponDiv.className = 'rounded bg-white/5 p-3'

          const couponContent = document.createElement('div')
          couponContent.className = 'flex justify-between text-xs text-white/70'

          const couponId = document.createElement('span')
          couponId.textContent = `ID: ${coupon.id || ''}`

          const couponDate = document.createElement('span')
          couponDate.textContent = usedDate

          couponContent.appendChild(couponId)
          couponContent.appendChild(couponDate)
          couponDiv.appendChild(couponContent)
          userCouponsList.appendChild(couponDiv)
        })
      } else {
        userCouponsCount.textContent = '0'
        userNoCoupons.classList.remove('hidden')
      }

      // Cargar logros del usuario
      await loadUserAchievements(data.id)

      userFound.classList.remove('hidden')
    } catch (error) {
      console.error('Error:', error)
      hideAllUserStates()
      userErrorMessage.textContent = 'Error al buscar el usuario. Int√©ntalo de nuevo m√°s tarde.'
      userError.classList.remove('hidden')
    }
  })

  // Elementos para logros
  const userAchievementsSection = $('#user-achievements-section') as HTMLDivElement
  const userAchievementsLoading = $('#user-achievements-loading') as HTMLDivElement
  const userAchievementsList = $('#user-achievements-list') as HTMLDivElement
  const userNoAchievements = $('#user-no-achievements') as HTMLDivElement

  // Funci√≥n para cargar logros de un usuario
  async function loadUserAchievements(userId: string) {
    if (!userId) return

    // Mostrar loading
    userAchievementsLoading.classList.remove('hidden')
    userAchievementsList.classList.add('hidden')
    userNoAchievements.classList.add('hidden')

    try {
      const response = await fetch(
        `/api/admin/user-achievements?userId=${encodeURIComponent(userId)}`
      )
      const data = await response.json()

      userAchievementsLoading.classList.add('hidden')

      if (!response.ok) {
        console.error('Error al cargar logros:', data.error)
        userNoAchievements.classList.remove('hidden')
        return
      }

      if (!data.achievements || data.achievements.length === 0) {
        userNoAchievements.classList.remove('hidden')
        return
      }

      // Limpiar lista anterior
      userAchievementsList.innerHTML = ''

      // Crear elementos de logros
      data.achievements.forEach((achievement: any) => {
        const achievementDiv = document.createElement('div')
        achievementDiv.className = `rounded-lg border p-3 transition-all ${
          achievement.unlocked
            ? 'bg-green-500/20 border-green-500/30'
            : 'bg-white/5 border-white/10 opacity-60'
        }`

        const achievementContent = document.createElement('div')
        achievementContent.className = 'flex flex-col items-center gap-2'

        // Imagen del logro
        const achievementImg = document.createElement('img')
        achievementImg.src = achievement.image
        achievementImg.alt = achievement.title
        achievementImg.className = `w-12 h-12 object-contain ${
          achievement.unlocked ? '' : 'grayscale'
        }`

        // T√≠tulo del logro
        const achievementTitle = document.createElement('p')
        achievementTitle.className = 'text-xs font-bold text-white text-center leading-tight'
        achievementTitle.textContent = achievement.title

        // Estado y bot√≥n
        const achievementActions = document.createElement('div')
        achievementActions.className = 'flex flex-col items-center gap-1 w-full'

        const achievementStatus = document.createElement('span')
        achievementStatus.className = `text-[10px] px-2 py-1 rounded ${
          achievement.unlocked ? 'bg-green-500/30 text-green-200' : 'bg-gray-500/30 text-gray-300'
        }`
        achievementStatus.textContent = achievement.unlocked ? '‚úÖ Desbloqueado' : 'üîí Bloqueado'

        const toggleButton = document.createElement('button')
        toggleButton.type = 'button'
        toggleButton.className = `w-full inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-sm font-medium focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring cursor-pointer transition-[background-color,transform] duration-150 ease-out hover:scale-[1.01] active:scale-[0.99] ${
          achievement.unlocked
            ? 'inset-shadow-2xs inset-shadow-white/10 bg-linear-to-t border border-b-2 border-zinc-950/40 from-red-500 to-red-500/85 text-white shadow-md shadow-zinc-950/20 ring-1 ring-inset ring-white/25 transition-[filter,transform] hover:brightness-110 active:brightness-90 px-4 py-2'
            : 'inset-shadow-2xs inset-shadow-white/10 bg-linear-to-t border border-b-2 border-zinc-950/40 from-brand to-brand/85 text-black shadow-md shadow-zinc-950/20 ring-1 ring-inset ring-white/25 transition-[filter,transform] hover:brightness-110 active:brightness-90 px-4 py-2'
        }`
        toggleButton.textContent = achievement.unlocked ? 'Desactivar' : 'Activar'
        toggleButton.onclick = () =>
          toggleAchievement(userId, achievement.id, !achievement.unlocked)

        achievementActions.appendChild(achievementStatus)
        achievementActions.appendChild(toggleButton)

        achievementContent.appendChild(achievementImg)
        achievementContent.appendChild(achievementTitle)
        achievementContent.appendChild(achievementActions)
        achievementDiv.appendChild(achievementContent)

        userAchievementsList.appendChild(achievementDiv)
      })

      userAchievementsList.classList.remove('hidden')
    } catch (error) {
      console.error('Error al cargar logros:', error)
      userAchievementsLoading.classList.add('hidden')
      userNoAchievements.classList.remove('hidden')
    }
  }

  // Funci√≥n para activar/desactivar un logro
  async function toggleAchievement(userId: string, achievementId: string, activate: boolean) {
    try {
      const response = await fetch('/api/admin/user-achievements', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId,
          achievementId,
          action: activate ? 'activate' : 'deactivate',
        }),
      })

      const data = await response.json()

      if (!response.ok) {
        alert(`Error: ${data.error || 'No se pudo actualizar el logro'}`)
        return
      }

      // Recargar logros
      await loadUserAchievements(userId)
    } catch (error) {
      console.error('Error al actualizar logro:', error)
      alert('Error al actualizar el logro. Int√©ntalo de nuevo.')
    }
  }
</script>
